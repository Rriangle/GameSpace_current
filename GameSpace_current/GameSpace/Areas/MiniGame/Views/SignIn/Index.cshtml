@model IEnumerable<GameSpace.Models.UserSignInStats>
@{
    ViewData["Title"] = "每日簽到";
    var signInStats = ViewBag.SignInStats as List<GameSpace.Models.UserSignInStats>;
    var pet = ViewBag.Pet as GameSpace.Models.Pet;
    var wallet = ViewBag.Wallet as GameSpace.Models.UserWallet;
    var userId = ViewBag.UserId as int?;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">每日簽到</h4>
                </div>
                <div class="card-body">
                    <!-- 簽到按鈕 -->
                    <div class="text-center mb-4">
                        <button id="signInBtn" class="btn btn-primary btn-lg" onclick="signIn()">
                            <i class="fas fa-calendar-check"></i> 立即簽到
                        </button>
                    </div>

                    <!-- 簽到狀態 -->
                    <div id="signInStatus" class="alert alert-info text-center" style="display: none;">
                        <i class="fas fa-check-circle"></i> <span id="statusMessage"></span>
                    </div>

                    <!-- 連續簽到天數 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">連續簽到</h5>
                                    <h2 class="text-primary" id="consecutiveDays">0</h2>
                                    <p class="card-text">天</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="card-title">總簽到次數</h5>
                                    <h2 class="text-success">@(signInStats?.Count ?? 0)</h2>
                                    <p class="card-text">次</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 本月簽到日曆 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">本月簽到日曆</h5>
                        </div>
                        <div class="card-body">
                            <div id="signInCalendar" class="calendar">
                                <!-- 日曆將由 JavaScript 生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- 寵物資訊 -->
            @if (pet != null)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">我的寵物</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="pet-avatar mb-3">
                            <div class="pet-circle" style="background-color: @pet.SkinColor;">
                                <i class="fas fa-heart"></i>
                            </div>
                        </div>
                        <h6>@pet.PetName</h6>
                        <p class="text-muted">等級 @pet.Level</p>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: @((pet.Experience * 100 / CalculateRequiredExp(pet.Level))%)">
                                @pet.Experience / @CalculateRequiredExp(pet.Level) EXP
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- 錢包資訊 -->
            @if (wallet != null)
            {
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">我的錢包</h5>
                    </div>
                    <div class="card-body text-center">
                        <h4 class="text-primary">@wallet.UserPoint</h4>
                        <p class="text-muted">會員點數</p>
                    </div>
                </div>
            }

            <!-- 簽到獎勵說明 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">簽到獎勵說明</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-coins text-warning"></i>
                            <strong>每日簽到：</strong> +20 點
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calendar-week text-info"></i>
                            <strong>假日獎勵：</strong> +10 點 + 200 經驗
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-fire text-danger"></i>
                            <strong>連續7天：</strong> +40 點 + 300 經驗 + 優惠券
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-trophy text-warning"></i>
                            <strong>連續30天：</strong> +200 點 + 2000 經驗 + 優惠券
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.pet-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    font-size: 2rem;
    color: white;
}

.calendar {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 0.9rem;
    cursor: pointer;
}

.calendar-day.signed {
    background-color: #28a745;
    color: white;
}

.calendar-day.today {
    background-color: #007bff;
    color: white;
}

.calendar-day.other-month {
    color: #6c757d;
    background-color: #f8f9fa;
}
</style>

<script>
function signIn() {
    const btn = document.getElementById('signInBtn');
    const status = document.getElementById('signInStatus');
    const message = document.getElementById('statusMessage');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 簽到中...';
    
    fetch('@Url.Action("SignIn", "SignIn")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            message.textContent = data.message;
            status.className = 'alert alert-success text-center';
            status.style.display = 'block';
            
            // 更新連續簽到天數
            document.getElementById('consecutiveDays').textContent = data.consecutiveDays;
            
            // 更新日曆
            updateCalendar();
            
            // 禁用簽到按鈕
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-check"></i> 今日已簽到';
            btn.className = 'btn btn-success btn-lg';
        } else {
            message.textContent = data.message;
            status.className = 'alert alert-danger text-center';
            status.style.display = 'block';
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-calendar-check"></i> 立即簽到';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        message.textContent = '簽到失敗，請稍後再試';
        status.className = 'alert alert-danger text-center';
        status.style.display = 'block';
        
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-calendar-check"></i> 立即簽到';
    });
}

function updateCalendar() {
    // 這裡可以實現日曆更新邏輯
    // 暫時簡單處理
    const today = new Date();
    const todayElement = document.querySelector(`[data-date="${today.getDate()}"]`);
    if (todayElement) {
        todayElement.classList.add('signed');
    }
}

// 生成日曆
document.addEventListener('DOMContentLoaded', function() {
    const calendar = document.getElementById('signInCalendar');
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    
    // 獲取本月第一天和最後一天
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    // 獲取第一天是星期幾
    const firstDayOfWeek = firstDay.getDay();
    
    // 生成日曆標題
    const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月',
                       '七月', '八月', '九月', '十月', '十一月', '十二月'];
    const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
    
    let calendarHTML = '<div class="calendar-header mb-3">';
    calendarHTML += `<h6 class="text-center">${year}年${monthNames[month]}</h6>`;
    calendarHTML += '</div>';
    
    // 星期標題
    calendarHTML += '<div class="calendar-weekdays mb-2">';
    weekDays.forEach(day => {
        calendarHTML += `<div class="text-center font-weight-bold">${day}</div>`;
    });
    calendarHTML += '</div>';
    
    // 生成日期
    calendarHTML += '<div class="calendar-days">';
    
    // 上個月的日期
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const date = new Date(year, month, -i);
        calendarHTML += `<div class="calendar-day other-month">${date.getDate()}</div>`;
    }
    
    // 本月的日期
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = day === today.getDate();
        const isSigned = @(signInStats?.Any(s => s.SignTime.Date == DateTime.Today) == true ? "true" : "false");
        
        let className = 'calendar-day';
        if (isToday) className += ' today';
        if (isSigned) className += ' signed';
        
        calendarHTML += `<div class="${className}" data-date="${day}">${day}</div>`;
    }
    
    calendarHTML += '</div>';
    
    calendar.innerHTML = calendarHTML;
});
</script>

@functions {
    private int CalculateRequiredExp(int level)
    {
        if (level <= 10)
        {
            return 40 * level + 60;
        }
        else if (level <= 100)
        {
            return (int)(0.8 * level * level + 380);
        }
        else
        {
            return (int)(285.69 * Math.Pow(1.06, level));
        }
    }
}