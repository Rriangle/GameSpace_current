@{
    ViewData["Title"] = "每日簽到";
    var hasSignedInToday = ViewBag.HasSignedInToday as bool? ?? false;
    var todaySignIn = ViewBag.TodaySignIn as GameSpace.Models.UserSignInStats;
    var monthSignIns = ViewBag.MonthSignIns as List<GameSpace.Models.UserSignInStats> ?? new List<GameSpace.Models.UserSignInStats>();
    var consecutiveDays = ViewBag.ConsecutiveDays as int? ?? 0;
    var today = ViewBag.Today as DateTime? ?? DateTime.UtcNow.Date;
}

<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">每日簽到</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>本月簽到日曆</h5>
                </div>
                <div class="card-body">
                    <div class="calendar">
                        <div class="calendar-header">
                            <h6>@today.ToString("yyyy年MM月")</h6>
                        </div>
                        <div class="calendar-grid">
                            @{
                                var monthStart = new DateTime(today.Year, today.Month, 1);
                                var monthEnd = monthStart.AddMonths(1).AddDays(-1);
                                var firstDayOfWeek = (int)monthStart.DayOfWeek;
                                var daysInMonth = monthEnd.Day;
                                
                                // 星期標題
                                var weekDays = new[] { "日", "一", "二", "三", "四", "五", "六" };
                            }
                            
                            <div class="calendar-weekdays">
                                @foreach (var day in weekDays)
                                {
                                    <div class="calendar-weekday">@day</div>
                                }
                            </div>
                            
                            <div class="calendar-days">
                                @for (int i = 0; i < firstDayOfWeek; i++)
                                {
                                    <div class="calendar-day empty"></div>
                                }
                                
                                @for (int day = 1; day <= daysInMonth; day++)
                                {
                                    var currentDate = new DateTime(today.Year, today.Month, day);
                                    var isSignedIn = monthSignIns.Any(s => s.SignTime.Date == currentDate);
                                    var isToday = currentDate == today;
                                    var isPast = currentDate < today;
                                    
                                    <div class="calendar-day @(isToday ? "today" : "") @(isSignedIn ? "signed-in" : "") @(isPast && !isSignedIn ? "missed" : "")">
                                        <span class="day-number">@day</span>
                                        @if (isSignedIn)
                                        {
                                            <i class="fas fa-check-circle text-success"></i>
                                        }
                                        else if (isToday)
                                        {
                                            <i class="fas fa-calendar-day text-primary"></i>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>今日簽到</h5>
                </div>
                <div class="card-body text-center">
                    @if (hasSignedInToday)
                    {
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <h5>已簽到</h5>
                            <p class="text-muted">@todaySignIn.SignTime.ToString("HH:mm")</p>
                        </div>
                        <div class="signin-rewards">
                            <h6>今日獎勵</h6>
                            <p><i class="fas fa-coins text-warning"></i> +@todaySignIn.PointsChanged 點數</p>
                            @if (todaySignIn.ExpGained > 0)
                            {
                                <p><i class="fas fa-star text-info"></i> +@todaySignIn.ExpGained 經驗值</p>
                            }
                            @if (todaySignIn.CouponGained > 0)
                            {
                                <p><i class="fas fa-ticket-alt text-success"></i> +@todaySignIn.CouponGained 優惠券</p>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-calendar-day fa-3x mb-3"></i>
                            <h5>尚未簽到</h5>
                            <p class="text-muted">點擊下方按鈕簽到</p>
                        </div>
                        <button id="signInBtn" class="btn btn-primary btn-lg">
                            <i class="fas fa-check me-2"></i>立即簽到
                        </button>
                    }
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5>連續簽到</h5>
                </div>
                <div class="card-body text-center">
                    <h3 class="text-primary">@consecutiveDays 天</h3>
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" style="width: @((consecutiveDays * 100.0 / 30)%)">
                            @consecutiveDays / 30
                        </div>
                    </div>
                    <p class="small text-muted">連續簽到 30 天可獲得額外獎勵</p>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5>簽到獎勵</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>平日：+20 點數</li>
                        <li><i class="fas fa-check text-success me-2"></i>假日：+30 點數 +200 經驗</li>
                        <li><i class="fas fa-check text-success me-2"></i>連續 7 天：+40 點數 +300 經驗 +1 優惠券</li>
                        <li><i class="fas fa-check text-success me-2"></i>連續 14 天：+60 點數 +500 經驗</li>
                        <li><i class="fas fa-check text-success me-2"></i>連續 30 天：+200 點數 +2000 經驗 +2 優惠券</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>簽到記錄</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <a href="@Url.Action("History", "SignIn")" class="btn btn-outline-primary">
                            <i class="fas fa-history me-2"></i>查看完整記錄
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.calendar {
    font-family: Arial, sans-serif;
}

.calendar-header {
    text-align: center;
    margin-bottom: 1rem;
    font-weight: bold;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    margin-bottom: 1px;
}

.calendar-weekday {
    background-color: #f8f9fa;
    padding: 0.5rem;
    text-align: center;
    font-weight: bold;
    border: 1px solid #dee2e6;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid #dee2e6;
    position: relative;
    background-color: #fff;
}

.calendar-day.today {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.calendar-day.signed-in {
    background-color: #e8f5e8;
    border-color: #4caf50;
}

.calendar-day.missed {
    background-color: #ffebee;
    border-color: #f44336;
}

.calendar-day.empty {
    background-color: #f8f9fa;
    border: none;
}

.day-number {
    font-weight: bold;
}

.signin-rewards {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.5rem;
}
</style>

@section Scripts {
    <script>
        $('#signInBtn').click(function() {
            $.post('@Url.Action("SignIn", "SignIn")', function(data) {
                if (data.success) {
                    showMessage(data.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showMessage(data.message, 'error');
                }
            });
        });

        function showMessage(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const alert = $(`<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`);
            $('.container').prepend(alert);
            setTimeout(() => alert.alert('close'), 5000);
        }
    </script>
}